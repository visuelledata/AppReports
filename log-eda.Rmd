---
title: "Untitled"
author: "Chris Peralta"
date: paste0("Last updated: ", lubridate::today())
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)

source("load_data.R")
```

```{r cleaning, include=FALSE} 
logs <- load_data()

cleaned <- logs %>% 
  mutate_if(is.numeric, as_datetime) %>% 
  select(app_name, everything()) %>% 
  mutate(duration = final_time - initial_time) %>% 
  filter_at(vars(one_of("app_name")), any_vars(!str_detect(., "%WIN"))) %>% 
  filter_at(vars(one_of("app_name")), any_vars(!str_detect(., "Notification"))) %>% 
  filter_at(vars(one_of("app_name")), any_vars(!str_detect(., "%WIN"))) %>% 
  filter_at(vars(one_of("app_name")), any_vars(!str_detect(., "Photos"))) %>% 
  filter_at(vars(one_of("app_name")), any_vars(!str_detect(., "Select"))) %>% 
  filter_at(vars(one_of("app_name")), any_vars(!str_detect(., "Filters"))) %>% 
  filter_at(vars(one_of("app_name")), any_vars(!str_detect(., "Home"))) %>% 
  filter_at(vars(one_of("app_name")), any_vars(!str_detect(., "Album"))) %>% 
  filter_at(vars(one_of("app_name")), any_vars(!str_detect(., "Post"))) %>% 
  filter_at(vars(one_of("app_name")), any_vars(!str_detect(., "Apps"))) %>% 
  filter_at(vars(one_of("app_name")), any_vars(!str_detect(., "Battery"))) %>% 
  filter_at(vars(one_of("app_name")), any_vars(!str_detect(., "Reply"))) %>% 
  filter_at(vars(one_of("app_name")), any_vars(!str_detect(., "Subreddit"))) %>% 
  filter_at(vars(one_of("app_name")), any_vars(!str_detect(., "info"))) %>% 
  filter_at(vars(one_of("app_name")), any_vars(!str_detect(., "Month"))) %>% 
  filter_at(vars(one_of("app_name")), any_vars(!str_detect(., "Camera"))) %>% 
  filter(duration != 82078) # Error: 23 hrs of TickTick

```



```{r vis}
cleaned %>% 
  group_by(app_name) %>% 
  summarize(total_duration = sum(duration)) %>% 
  arrange(desc(total_duration)) %>% 
  View()
```

```{r hours}
cleaned %>%
  group_by(dayfu = floor_date(initial_time, "day")) %>%
  summarize(total_dur = sum(duration)) %>%
  qplot(x = dayfu, y = total_dur/3600, data = ., geom = "path")
```

```{r viz}
# qplot(x = as.integer(duration), data = cleaned, 
#       geom = "histogram", bins = 100)

top10 <- cleaned %>% 
  group_by(app_name) %>% 
  summarize(total_dur = sum(duration)) %>% 
  arrange(desc(total_dur)) %>% 
  head(10) %>% 
  pull(app_name)


cleaned %>%
  filter(app_name %in% top10) %>% 
  group_by(app_name, dayfu = floor_date(initial_time, "day")) %>%
  summarize(total_dur = sum(duration)) %>%
  filter(dayfu > ymd("2018-06-01")) %>% 
  ggplot(aes(x = dayfu, y = total_dur)) + 
  geom_path(aes(color = app_name), size = 1.2)
  #qplot(x = dayfu, y = total_dur/60, data = ., geom = "path", color = app_name)

```

```{r daily}
cleaned %>% 
  mutate(dates = floor_date(initial_time, "day")) %>% 
  group_by(dates) %>% 
  summarize(hours_used = sum(duration) / 3600) %>%
  ggplot(aes(x = dates, y = hours_used)) +
  geom_smooth(se = FALSE)
```
